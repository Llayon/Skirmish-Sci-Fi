# Interaction Contract (2D/3D Battle)

## Цель
- Единые ожидания игрока при переключении 2D/3D: та же “мышечная память”, одинаковые смыслы действий.
- Предсказуемые приоритеты кликов и горячих клавиш.
- Явные правила блокировки ввода, когда открыт UI (модалки/оверлеи).

## Состояния
- **Idle**: действие не выбрано, клик по юниту выбирает юнита.
- **UnitSelected**: выбран юнит, но действие не выбрано.
- **Targeting**: игрок выбирает клетку/цель для действия.
- **Confirming**: ожидается подтверждение выбора (если появляется).
- **EnemyTurn**: ввод ограничен (только просмотр/инспект), кроме UI.
- **Spectating**: ввод ограничен (как EnemyTurn).
- **UIBlocked(Modal)**: открыта модалка; боевые хоткеи не работают (кроме Esc внутри модалки).

## Приоритеты ввода
1. **UI элемент** (кнопки/панели/модалки/скроллы) всегда получает ввод первым.
2. **Юнит** имеет приоритет над клеткой (и в 2D, и в 3D).
3. **Клетка** обрабатывается, если юнит в точке клика не выбран/не попал под хиттест.

## Горячие клавиши (общие)
- **Esc**: отмена текущего действия/режима (Targeting/Confirming → Idle). Если модалка открыта — модалка решает сама.
- **Tab**: цикл выбора юнитов (живые участники, без casualty). В соло — приоритетно по активному, затем остальные; в мультиплеере — приоритет по “моей” стороне.
- **ПКМ**: отмена действия (как Esc) и подавление контекстного меню браузера на боевом поле.

## Камера (3D)
- **F**: фокус камеры на выбранном (если нет — на активном).
- **R**: сброс камеры.

## Правила клика по состояниям
### Idle / UnitSelected
- ЛКМ по юниту: выбрать юнита, отменить незавершённое действие.
- ЛКМ по клетке: ничего (если нет активного режима).

### Targeting / Confirming
- ЛКМ по клетке/цели: применить `handleGridClick(pos)`.
- ЛКМ по юниту: трактуется как выбор цели/клетки (через `handleGridClick`), если логика это допускает.
- Esc/ПКМ: отмена (`cancelAction()`).

## Блокировка ввода
- Если `role="dialog" aria-modal="true"` присутствует: боевые хоткеи не выполняются.
- Ввод в `input/textarea/contenteditable` не перехватывается боевыми хоткеями.

