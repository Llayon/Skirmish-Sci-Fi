# План улучшения игрового UI

## Контекст
Сейчас UI построен на React и Zustand, экраны переключаются через `gameMode` в UI-сторе. Основная стилизация — Tailwind, подключённый через CDN и настроенный в `index.html`, плюс CSS-переменные и кастомные классы в `index.css`.

## Цели
- Повысить читаемость и иерархию информации на всех ключевых экранах.
- Сделать взаимодействие предсказуемым (особенно в бою: выбор/hover/цель/камера/горячие клавиши).
- Довести визуальный язык до консистентного “sci‑fi HUD”, не ломая производительность.
- Снизить стоимость поддержки UI: единые примитивы, токены, правила компоновки, тестируемость.

## Текущая карта UI (что где живёт)
- Точка входа UI: [App.tsx](file:///d:/Max/skirmish/skirmish-sci-fi/App.tsx)
- Переключение экранов: [uiStore.ts](file:///d:/Max/skirmish/skirmish-sci-fi/stores/uiStore.ts)
- Lazy-прелоад экранов/модалок: [componentPreloader.ts](file:///d:/Max/skirmish/skirmish-sci-fi/services/utils/componentPreloader.ts)
- Основные экраны:
  - Главное меню: [MainMenu.tsx](file:///d:/Max/skirmish/skirmish-sci-fi/components/MainMenu.tsx)
  - Хаб кампании: [CampaignDashboard.tsx](file:///d:/Max/skirmish/skirmish-sci-fi/components/CampaignDashboard.tsx)
  - Предбой: [PreBattleBriefing.tsx](file:///d:/Max/skirmish/skirmish-sci-fi/components/PreBattleBriefing.tsx)
  - Бой (2D/3D + HUD): [BattleView.tsx](file:///d:/Max/skirmish/skirmish-sci-fi/components/battle/BattleView.tsx), [BattleHUD.tsx](file:///d:/Max/skirmish/skirmish-sci-fi/components/battle/BattleHUD.tsx)
  - 3D бой: [BattleView3D.tsx](file:///d:/Max/skirmish/skirmish-sci-fi/components/battle/BattleView3D.tsx), [ThreeCanvas.tsx](file:///d:/Max/skirmish/skirmish-sci-fi/components/battle/three/ThreeCanvas.tsx)
  - Постбой: [PostBattleSequence.tsx](file:///d:/Max/skirmish/skirmish-sci-fi/components/PostBattleSequence.tsx)
  - Мультиплеер: [MultiplayerLobby.tsx](file:///d:/Max/skirmish/skirmish-sci-fi/components/MultiplayerLobby.tsx)
- UI-примитивы:
  - [Button.tsx](file:///d:/Max/skirmish/skirmish-sci-fi/components/ui/Button.tsx), [Card.tsx](file:///d:/Max/skirmish/skirmish-sci-fi/components/ui/Card.tsx), [Modal.tsx](file:///d:/Max/skirmish/skirmish-sci-fi/components/ui/Modal.tsx), [Tooltip.tsx](file:///d:/Max/skirmish/skirmish-sci-fi/components/ui/Tooltip.tsx)
- Темизация: [ThemeContext.tsx](file:///d:/Max/skirmish/skirmish-sci-fi/context/ThemeContext.tsx)
- Токены/кастомные стили: [index.css](file:///d:/Max/skirmish/skirmish-sci-fi/index.css), Tailwind-конфиг через CDN: [index.html](file:///d:/Max/skirmish/skirmish-sci-fi/index.html)

## Проблемы и возможности (по наблюдениям в коде)
- Консистентность: часть UI имеет “sci‑fi” декор (главное меню), часть — утилитарный вид (бой/дашборд), правила панелей/кнопок не везде одинаковы.
- Бой: HUD содержит много информации одновременно; “minimal UI” пока редуцирует только до блока действий, но не решает управляемость панелей (лог/статус/миссия/очередь).
- Производительность: `BattleHUD` обновляет состояние на каждый `mousemove` для позиционирования `TargetInspector`, что может вызывать лишние перерендеры.
- Доступность: часть интерактивных элементов — кастомные кнопки/кликабельные контейнеры; фокус/keyboard-навигация и ARIA-лейблы следует унифицировать и проверить.
- Поддерживаемость: Tailwind используется через CDN и конфиг задаётся в `index.html`, а `index.css` содержит `@tailwind` директивы, которые не являются источником правды для текущей сборки.

## План улучшений (по приоритету)

### Фаза 0 — Привести Tailwind к одному источнику правды (1–2 дня)
- Цель: убрать конфликт “CDN-конфиг в index.html” vs `index.css` и подготовить базу для токенов/примитивов.
- Подход (предпочтительный): Tailwind в сборке (tailwindcss + postcss), конфиг в `tailwind.config`, удалить CDN-скрипт из `index.html`.
- Визуальная страховка: зафиксировать 15–30 скриншотов ключевых экранов (или скриншот‑тесты) до миграции.
- Критерий: один способ конфигурировать цвета/анимации/брейкпоинты, прогнозируемая генерация классов.

### Фаза A.1 — Quick wins без изменения дизайна (2–3 дня)
- Перфоманс HUD: быстрые меры
  - Пересмотреть подписки на Zustand в боевых панелях: селекторы + `shallow`, минимизация derived data на каждый ререндер.
  - Лог боя: ограничение видимых элементов и/или простая виртуализация (если потребуется).
- `TargetInspector`: упростить обновление позиции
  - Обновлять позицию только при активном hover по цели.
  - Использовать `ref` для координат и триггерить перерендер редко (throttle/по таймеру), без сторонних зависимостей.
  - Критерий: движение мыши не вызывает непрерывных тяжелых перерисовок HUD.
- Reduced motion / Reduced VFX
  - Единая настройка, которая отключает/ослабляет эффекты (scan-lines/parallax/избыточные анимации).
  - Критерий: меню и HUD остаются отзывчивыми на слабых машинах.
- Settings слой (фундамент под пресеты)
  - Завести отдельный persist‑store для настроек (например: motion/vfx/quality), чтобы не размазывать по компонентам.

### Фаза B — Фундамент дизайн‑системы (3–5 дней)
- UI токены (не только цвета)
  - Цвета/радиусы/тени/blur/прозрачности.
  - Типографика (scale для заголовков/лейблов/цифр) и spacing (плотность: compact/normal).
  - Критерий: визуальные изменения делаются через токены, а не точечными значениями.
- Единые примитивы как обязательный слой
  - Укрепить и унифицировать `Button/Card/Modal/Tooltip`.
  - Ввести 2–3 варианта панелей (HUD / Dashboard / Overlay) как тонкие обёртки вокруг `Card`.
  - Критерий: новые панели создаются без копирования больших блоков классов.
- A11y минимум в примитивах (стандарт)
  - Focus visible, корректные `aria-*` для иконок без текста, управляемость с клавиатуры.
  - Для модалок: focus trap + возврат фокуса на триггер.
  - Критерий: базовые примитивы “безопасны по умолчанию”.

### Фаза A.2 — Управляемость HUD (2–3 дня, после Фазы B)
- HUD layout ownership
  - Завести отдельный persist‑store для HUD (layout/presets/свёрнутость панелей).
  - Пресет = “стартовая конфигурация”, которую пользователь может далее кастомизировать.
- Реализовать управляемость
  - Collapsible panels (лог/миссия/статус/очередь), компактные режимы.
  - Пресеты HUD: Full / Tactical / Spectator.
  - Критерий: игрок может убрать второстепенные панели, не теряя действий и контекста хода.

### Фаза C — Боевой UI parity (5–7 дней, разбить на подфазы)
- Артефакт перед началом: Interaction Contract (1–2 страницы)
  - Состояния: `Idle / UnitSelected / Targeting / Confirming / EnemyTurn / Spectating / UIBlocked(Modal)`.
  - События/интенты: `hoverUnit/clickUnit/clickTile/rightClick/esc/confirm/tabCycle/cameraFocus`.
  - Приоритеты конфликтов: юнит vs клетка; UI‑элемент vs сцена; что блокирует ввод.
  - HUD обязательные элементы по состояниям.
- C.1 (2–3 дня): единые правила ввода (2D и 3D)
  - Важно: “единая” — про смысл и ожидания игрока, а не про идентичный визуал и не про одинаковую реализацию ввода.
  - Что унифицировать обязательно: приоритет клика, hover-инфо, отмена/подтверждение, хоткеи, термины/статусы, правила блокировки действий.
  - Что может отличаться: камера/навигация, точность хиттестинга, визуал подсветок, “прощение” ввода в 3D.
  - Критерий: переключение 2D/3D не меняет “мышечную память”.
- C.2 (2–3 дня): информационная иерархия HUD
  - “Что делать сейчас?” (action block) — всегда приоритет.
  - “Что происходит?” (лог) — доступен, но не перетягивает внимание; фильтры (ход/урон/статусы).
  - “Что важно?” (миссия/очередь) — компактный режим и раскрытие по необходимости.
  - Критерий: на типичном ходе игрок видит 3–5 ключевых сигналов, а не десяток панелей.
- C.3 (1–2 дня): hotkeys + подсказки управления
  - Панель “?” и короткая подсказка, включая 3D-камеру.
  - Критерий: игрок понимает управление в 3D без внешних инструкций.

### Фаза D — 3D UI и визуальная читаемость сцены (параллельно Фазе C)
- Использовать и уточнить специализированный план: [3D_UI_Battle_Plan.md](file:///d:/Max/skirmish/skirmish-sci-fi/docs/3D_UI_Battle_Plan.md)
- Дополнения к 3D-плану (привязка к текущему коду)
  - Камера: команды reset/focus уже есть, довести до UX-уровня (иконки, тултипы, хоткеи, визуальный feedback). Точки: `BattleView.tsx`, `CameraCommands3D.tsx`.
  - Touch controls для 3D-камеры: pinch‑to‑zoom, two‑finger pan, tap vs long‑press (selection/inspect).
  - World-space HUD: стандартизировать выделение/подсветки/путь перемещения. Точки: `MoveHighlights.tsx`, `HPBars3D.tsx`, `ParticipantMesh.tsx`.
  - Качество/перфоманс: профили качества и отключаемые эффекты. Точки: `ThreeCanvas.tsx`, `constants/three.ts`.

### Фаза E — Кампания и менеджмент (5–10 дней)
- Дашборд: уменьшить когнитивную нагрузку
  - Группировать действия по намерению (Turn / Jobs / Crew / Ship / Travel), убрать “прострел” модалками, где можно — inline панели.
  - Добавить “сводку дня” (turn summary) и индикаторы “требует внимания”.
  - Критерий: игрок понимает следующий шаг за 5 секунд.
- Модалки: единые размеры/скролл/хедеры
  - Критерий: нет модалок с разным поведением скролла/закрытия/фокуса.

## Метрики производительности (чтобы критерии были измеримыми)
- Целевой FPS: 60fps (≈16.67ms на кадр) на “типовых” картах.
- Бюджет HUD (ориентир): ≤5ms на кадр на взаимодействиях (mousemove/hover/панели).
- 3D сцена: ограничение памяти/геометрии задаётся профилем качества (Low/Med/High), эффекты отключаемы.

## Тестирование и критерии готовности
- Мини-набор ручных сценариев (по каждому экрану): загрузка, переключения, мобильная ширина, тёмная/светлая тема.
- Набор UI-тестов на ключевые компоненты (HUD toggle, модалки, tooltip, переключение 2D/3D).
- Критерии:
  - Консистентный стиль: панели/кнопки/типографика соответствуют токенам.
  - Бой: клики и hover устойчивы, панели управляемы, минимальный HUD функционален.
  - 3D: камера предсказуемая, сцена читаемая, FPS стабилен на типовых картах.
  - Доступность: управляемость с клавиатуры, фокус-стили, корректные ARIA-лейблы.

## Accessibility checklist (применять на каждой фазе)
- [ ] Focus visible на всех интерактивных элементах
- [ ] ARIA labels на иконках без текста
- [ ] Keyboard navigation для новых компонентов
- [ ] Color contrast ≥ 4.5:1 для текста/важных индикаторов

## Continuous (не блокирует фазы)
- Локализация (scope)
  - В первую очередь: critical path strings (HUD, боевые подсказки, основные кнопки).
  - Остальное: по мере затрагивания, без “бездонного” рефакторинга.

## Риски и как их снизить
- Перенос Tailwind с CDN на сборку может затронуть внешний вид: делается через “параллельный режим” (ветка/фича-флаг) и сравнение скриншотов.
- Сильные визуальные изменения могут мешать игре: внедрять через пресеты/настройки (Reduced motion, HUD presets).
- Перфоманс 3D: любые пост-эффекты и тени делать отключаемыми и профилируемыми.
- Риск распухания UI-сторов: разделить ответственность (экраны/модалки vs HUD layout vs settings).
- Риск падения читабельности от sci‑fi эффектов: токенизировать blur/overlay и делать отключаемым per‑panel.
